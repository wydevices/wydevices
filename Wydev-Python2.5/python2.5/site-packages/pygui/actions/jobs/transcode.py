# -*- coding: utf-8 -*- 
#
# Description:
#
# Transcode Action Job Class Definition
#
#
#
# Changes:
#
# 2014-04-07
# Initial Commit
#
#
# Copyright 2010-2014, WyDev Team.
# Author: Polo35 (polo35580@hotmail.fr)
#
# Licenced under Academic Free License version 3.0
# Review WyGui README & LICENSE files for further details.


from __future__ import absolute_import

import os
from peewee.messages import send as louie_send
from pygui.shared import pygui_globs
from peewee.notifier import Task
from pygui.config import user_config, TMP_DIR
from pygui.window import MessageWindow
from time import sleep
from peewee.debug import GET_LOGGER

log = GET_LOGGER(__name__)
transcode_resolution = (720, 480, 1, 50)
change_resolution = True
thm_src_file = '/usr/share/pygui/skins/wybox/icons/mimetypes/psp_thumb_wyplay.thm'


def _set_resolution(resolution):
	w, h, interlaced, freq = resolution
	pygui_globs['display'].set_resolution((w, h), interlaced, freq)
	return None


# Find the first available filename one the PSP
def _get_psp_filenames(psp_path):
	index = 99999
	join = os.path.join
	exists = os.path.exists
	psp_prefix = os.path.join(psp_path, 'video', 'M4V')
	while exists(psp_prefix + '%s.MP4' % index) or exists(psp_prefix + '%s.THM' % index):
		index -= 1
	return (psp_prefix + '%s.MP4' % index, psp_prefix + '%s.THM' % index)


def _copy_ts(ts_file, psp_path):
	psp_mp4_file, psp_thm_file = _get_psp_filenames(psp_path)
	msg = MessageWindow(_('Copying to PSP (tm) please wait...'), button=None)
	msg.show()
	mp4_cmd = '/usr/bin/ts2psp "%s" "%s"' % (ts_file, psp_mp4_file)
	thm_cmd = 'cp "%s" "%s"' % (thm_src_file, psp_thm_file)
	log.debug(mp4_cmd)
	os.system(mp4_cmd)
	log.debug(thm_cmd)
	os.system(thm_cmd)
	os.system('sync')
	sleep(2)
	msg.hide()
	return None


def _stop_transcode(stop_method, previous_resolution, player, output_file, psp_path):
	log.debug('transcode_stop()')
	stop_method()
	if change_resolution:
		Task(_set_resolution, previous_resolution).start(0.20000000000000001)
	Task(_copy_ts, output_file, psp_path).start(0)
	raise StopIteration()


def transcode(context):
	transcode_client = None
	bus = pygui_globs['wydbus']
	try:
		transcode_client = bus.reference('com.wyplay.record', '/com/wyplay/record_status')
		transcode_client_start = transcode_client.method('start', '', '')
		transcode_client_stop = transcode_client.method('stop', '', '')
		transcode_client_set_file = transcode_client.method('set_file', 's', '')
	except Exception, e:
		print 'Cannot load transcode',
		print str(e)
	except:
		print 'Cannot load transcode.'
	if transcode_client:
		previous_resolution = user_config['connections']['resolution']
		player = context['selected'].player
		item = context['selected']
		psp_path = context['psp_path'].split('//', 1)[1]
		output_file = os.path.join(TMP_DIR, 'transcode_%s.ts' % item.name)
		if change_resolution:
			_set_resolution(transcode_resolution)
		pygui_globs['menustack'].back_one_menu()
		context['menu'].stop()
		transcode_client_set_file(output_file)
		item.execute()
		louie_send('on_user_idle', player)
		log.debug('transcode_start() output_file=%s' % output_file)
		transcode_client_start()
		stop_task = Task(_stop_transcode, transcode_client_stop, previous_resolution, context['selected'].player, output_file, psp_path)
		player.stop_transcode = stop_task.start
	return None
