# -*- coding: utf-8 -*- 
#
# Description:
#
#  Definition Definition of BareLirc control plugin
#
#
#
# Changes:
#
# 2014-03-24
# Initial Commit
#
#
# Copyright 2010-2014, WyDev Team.
# Author: Polo35 (polo35580@hotmail.fr)
#
# Licenced under Academic Free License version 3.0
# Review WyGui README & LICENSE files for further details.

from __future__ import absolute_import

import peewee.notifier as notifier
from peewee.debug import log
from Queue import Full
from pygui.input import DIRECTFB_MAP
from socket import socket, AF_UNIX, SOCK_STREAM


# Plugin for stdin control.
class PluginInterface(object):

	def __init__(self, post_key):
		try:
			self.lircd = socket(AF_UNIX, SOCK_STREAM)
			self.lircd.connect('/dev/lircd')
		except:
			log.error("Can't load lirc plugin")
			del self.lircd
		else:
			notifier.descriptor_watch(self.lircd.fileno(), self.handle)
			self.kbmap_get = DIRECTFB_MAP.get
			self.post_key = post_key
		return None

	def handle(self):
		try:
			code, rep, keycode, garbage = self.lircd.recv(512).split(None, 3)
			rep = int(rep, 16)
			if 0 < rep < 5:
				keycode = None
		except Exception, e:
			print 'Invalid keycode',
			print str(e)
			keycode = None
		mapped = (self.kbmap_get(keycode.upper()) if keycode else None)
		if keycode is not None and mapped is not None:
			try:
				self.post_key(mapped)
			except Full:
				pass
			except KeyError:
				print 'Unmapped key: %s.' % keycode
		return True
