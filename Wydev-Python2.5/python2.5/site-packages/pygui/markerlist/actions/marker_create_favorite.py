# -*- coding: utf-8 -*- 
#
# Description:
#
# MarkerList Actions Create Favortie Class Definition
#
#
#
# Changes:
#
# 2014-04-07
# Initial Commit
#
#
# Copyright 2010-2014, WyDev Team.
# Author: Polo35 (polo35580@hotmail.fr)
#
# Licenced under Academic Free License version 3.0
# Review WyGui README & LICENSE files for further details.


from __future__ import absolute_import

from wymedia.wmplus import BrowseError, CreateContainerError, FilenameExistsError
from pygui.item.mediaitem.core import Playlist, HiddenRoot
from pygui.shared import pygui_globs
from pygui.markerlist import markerlists


caption = 'Create a favorite with the marked items'


# Only works in the TV navigator.
def is_compatible(context):
	return context['menu'].type == 'tv_navigator'


# Create a TV favorite from the TV markerlist, displaying a keyboard window to name it.
# 
# The TV favorite is created in the favorites root.
def execute(context):
	from pygui.window import KeyboardWindow, MessageWindow
	menu = context['menu']
	mlist = markerlists().get(menu.universe)
	favorites_root = HiddenRoot().get_child('TV Favorites', menu)
	def __create(k):
		name = k._text.strip()
		title = _("Can't use that name")
		if not name:
			message = _('That name is not valid. Choose another one.')
			MessageWindow(message, title, button=None).show(timeout=5)
			return None
		try:
			mlist.create_playlist(container=favorites_root, name=name)
			k.hide()
			menu.back_to_root()
			pygui_globs['menustack'].back_to_menu(menu)
		except CreateContainerError:
			MessageWindow(text=_('Error while creating the favorite.'), title=_('Error')).show(timeout=5)
		except FilenameExistsError:
			MessageWindow(text=_('A favorite with that name already exists.'), title=title).show(timeout=5)
		return None
	try:
		others = sum((isinstance(x, Playlist) for x in favorites_root.browse()))
	except BrowseError:
		menu.back_to_root()
		context['parent'].show_menu()
		return None
	if others:
		txt = _('New Favorite %i') % (others + 1)
	else:
		txt = _('New Favorite')
	kbd = KeyboardWindow(_('Name this favorite'), text=txt, confirm_action=__create)
	kbd.show()
	return None
