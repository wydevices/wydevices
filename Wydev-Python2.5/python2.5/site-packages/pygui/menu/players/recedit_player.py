# -*- coding: utf-8 -*- 
#
# Description:
#
# Records Editor Player
# Video player with a marker allowing to select video parts
# Selected parts are copied to a new video
#
#
#
# Changes:
#
# 2012-04-29
# Initial Commit
#
#
# Copyright 2010-2012, WyDev Team.
# Author: Polo35 (polo35580@hotmail.fr)
#
# Licenced under Academic Free License version 3.0
# Review WyGui README & LICENSE files for further details.

from peewee.formatters import int_to_percent

from pygui.menu import selective_gui_updater
from pygui.menu.players.video_player import VideoPlayer
from pygui.eventmanager.players.recedit_player import RecEditEventHandler
from pygui.shared import pygui_globs


class RecEditPlayer(VideoPlayer):
	def __init__(self, type_='recedit_player'):
		VideoPlayer.__init__(self, type_=type_)
		self.video_name = ''
		self.delete_record = 'no'
		self.mark_list = []
		self.current_mark = dict()
		self.last_mark_time = -0.1
		self.playmode = 'off'
		self.repeat_mode = 'off'
		self.copy_buf_size = 8
		self.eventhandler = RecEditEventHandler(self)

	def compute_pos(self, current):
		res = min(100, max(0, ((current * 100.0) / self.total_time)))
		return int_to_percent(res)

	def could_remove_banner(self):
		return False

	def tick_callback(self):
		VideoPlayer.tick_callback(self)
		try:
			player_obj    = pygui_globs['display'].get_obj_by_name('recedit_player')
			progressbar_obj = player_obj.get_obj_by_name('progressbar')
			mark_list_obj = player_obj.get_obj_by_name('mark_list')
			for bar in mark_list_obj.get_list_obj_by_name('mark_bar'):
				current_bar = bar
			if 'start' in self.current_mark:
				if self.time_elapsed > self.last_mark_time:
					current_bar.move(left = self.compute_pos(self.current_mark['start']['time']))
					current_bar.resize(width = self.compute_pos(self.time_elapsed - self.current_mark['start']['time']))
			else:
				current_bar.move(left = '100%')
				current_bar.resize(width = '0%')
		except:
			print 'Enable to set mark pos'

__all__ = ['RecEditPlayer']
