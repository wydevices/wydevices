# -*- coding: utf-8 -*- 
#
# Description:
#
# YouPorn Class Definitions
# Protected by parental control
#
#
#
# Changes:
#
# 2012-01-10
# Initial Commit
#
#
# Copyright 2010-2014, WyDev Team.
# Author: Polo35 (polo35580@hotmail.fr)
#
# Licenced under Academic Free License version 3.0
# Review WyGui README & LICENSE files for further details.

from __future__ import absolute_import

import re
import urllib2
from peewee.misc_utils import MetaSingleton
from pygui.item.containers import GenericContainer
from pygui.item.mediaitem.core import MediaItem, VideoItem
from peewee.cache_utils import cache_result
from peewee.debug import GET_LOGGER

log = GET_LOGGER(__name__)
cook_opener = urllib2.build_opener(urllib2.HTTPCookieProcessor())



def get_site(opts=''):
	return cook_opener.open('http://youporn.com/' + opts).read()



class YoupornVideo(VideoItem):

	flv_re = re.compile('"([^"]+?\\.flv)"')

	def __init__(self, url, icon, video_id, thumb, title, **kw):
		self.vid_id = video_id
		self.thumb = thumb
		self._uri = None
		VideoItem.__init__(self, title, uri=self.get_uri, thumbnail=thumb, **kw)
		return None

	def get_uri(self):
		if self._uri is None:
			site = get_site('watch/' + self.vid_id)
			self._uri = self.flv_re.findall(site)[0]
		return self._uri

	def get_thumbnail(self):
		return self.thumb



class YoupornContainer(MediaItem, GenericContainer):

	__metaclass__ = MetaSingleton

	def __init__(self, parent=None, page=1, **kw):
		MediaItem.__init__(self, 'YouPorn', type_='youtubedir', **kw)
		self.parent = parent
		self._items = None
		self._re = re.compile('<a href="(/watch/[^"]+)">[^<]+<img .*?src="([^"]+)"[^>]+>[^<]+</a>[^<]+<h1><a href="[^"]+">([^<]+)</a></h1>[^<]+<div class="duration_views">[^<]+<h2>(\d+)<span>:</span>(\d+)</h2>')
		self.page = str(page)
		return None

	def execute(self, *args, **kw):
		return None

	@cache_result(600)
	def browse(self, preview=False):
		site = get_site('?user_choice=Enter&page=%s' % self.page)
		for item in self._re.findall(site):
			print item
		return []
#		return [YoupornVideo(parent=self, menu=self.menu, *a) for a in self._re.findall(site)]

#########################################################
## YouPorn VideoPortal
#########################################################
#start=http://www.youporn.com/browse
#catcher=youporn.com
#header=Cookie|age_check=1
#########################################################
## Videos
#########################################################
#item_infos=<a href="(/watch/[^"]+)">[^<]+<img .*?src="([^"]+)"[^>]+>[^<]+</a>[^<]+<h1><a href="[^"]+">([^<]+)</a></h1>[^<]+<div class="duration_views">[^<]+<h2>(\d+)<span>:</span>(\d+)</h2>
#item_order=url|icon|title|title.tmp|title.append.append
#item_info_name=type
#item_info_build=video
#item_info_name=title.append.append
#item_info_build=%s)
#item_info_name=title.append
#item_info_from=title.tmp
#item_info_build= (%s:
#item_url_build=http://www.youporn.com%s
#########################################################
## Categories
#########################################################
#item_infos=<li><a href="(/category/\d+/[^"]+/)">([^"]+)</a></li>
#item_order=url|title
#item_skill=directory
#item_info_name=title
#item_info_build=video.devil.locale|30100
#item_info_name=icon
#item_info_build=video.devil.image|face_devil_grin.png
#item_url_build=http://www.youporn.com%s
#########################################################
## Subcategories
#########################################################
#item_infos=<li>[^<]+<div><a href="(/[^"]+)".*?>([^<]+)</a></div>
#item_order=url|title
#item_skill=directory
#item_curr=<li class="selected">[^<]+<div><a href="/[^"]+".*?>([^<]+)</a></div>
#item_info_name=title
#item_info_build=video.devil.locale|30109
#item_info_name=icon
#item_info_build=video.devil.image|face_kiss.png
#item_url_build=http://www.youporn.com%s
#########################################################
#item_infos=<a href="(/browse/[^"]+)">([^<]+)</a>[^>]+</li>
#item_order=url|title
#item_skill=directory
#item_curr=<a href="/browse/[^"]+" class="current">([^<]+)</a>[^>]+</li>
#item_info_name=title
#item_info_build=video.devil.locale|30109
#item_info_name=icon
#item_info_build=video.devil.image|face_kiss.png
#item_url_build=http://www.youporn.com%s
#########################################################
#item_infos=<a href="(/search/[^"]+)">([^<]+)</a>
#item_order=url|title
#item_skill=directory
#item_curr=<a href="/search/[^"]+" class="current">([^<]+)</a>
#item_info_name=title
#item_info_build=video.devil.locale|30109
#item_info_name=icon
#item_info_build=video.devil.image|face_kiss.png
#item_url_build=http://www.youporn.com%s
#########################################################
## Next
#########################################################
#item_infos=\<span\ class\="dots"\>\.\.\.\<\/span\>[^<]+\<a\ href\="[^=]+=\d+"[^<]+</a>[^<]+\<a\ href\="[^=]+=\d+"[^<]+</a>[^<]+\<a\ href\="([^=]+=\d+)"[^<]+</a>[^<]+\</div>
#item_order=url
#item_skill=space|lock
#item_info_name=title
#item_info_build=video.devil.locale|30103
#item_info_name=icon
#item_info_build=video.devil.image|next.png
#item_url_build=http://www.youporn.com%s
#########################################################
#item_infos=<a href="/search[^"]+" class="current">\d+</a>[^<]+<a href="(/search[^"]+)">\d+</a>
#item_order=url
#item_skill=space|lock
#item_info_name=title
#item_info_build=video.devil.locale|30103
#item_info_name=icon
#item_info_build=video.devil.image|next.png
#item_url_build=http://www.youporn.com%s
#########################################################
## Search
#########################################################
#title=video.devil.locale|30102
#type=search
#icon=video.devil.image|search.png
#url=http://www.youporn.com/search?query=%s
#########################################################