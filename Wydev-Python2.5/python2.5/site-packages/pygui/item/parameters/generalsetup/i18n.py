# -*- coding: utf-8 -*- 
#
# Description:
#
# i18n Parameters Items Class Definitions
#
#
#
# Changes:
#
# 2012-04-12
# Initial Commit
#
#
# Copyright 2010-2012, WyDev Team.
# Author: Polo35 (polo35580@hotmail.fr)
#
# Licenced under Academic Free License version 3.0
# Review WyGui README & LICENSE files for further details.


from __future__ import absolute_import

import pygui.config as config

from peewee.debug import GET_LOGGER
from pygui.facilities.codemapping import country_dict
from pygui.facilities import l10n
from pygui.item.core import ActionItem
from pygui.item.parameters import UserConfigSetupItem

log = GET_LOGGER(__name__)



class LanguageItem(ActionItem):

	def __init__(self, language, translator):
		ActionItem.__init__(self, name=language.title(), action=self.translate, type_='')
		self.translator = translator
		return None

	def translate(self):
		self.translator.install()
		return None



def getitem():
	from pygui.facilities import l10n
	return [LanguageItem(iso, translator) for iso, translator in l10n.available_languages.iteritems()]



class CountryUserConfigSetupItem(UserConfigSetupItem):

	translation_dict = l10n.UnicodeDict(dict(([code, country_dict[code]['country']] for code in country_dict)))
	depth = 2

	def execute_action(self, val):
		try:
			iso_3166_lang = country_dict[val]['iso-3166']
			from pygui.item.parameters.tv import wyscanserver
			wyscan = wyscanserver()
			wyscan.SetIso3166CountryCode(iso_3166_lang)
		except Exception , e:
			log.warn('Unable to set the country for wyscan (%r)', e)
		return None



class LanguageUserConfigSetupItem(UserConfigSetupItem):

	def __init__(self, *args, **kw):
		self.translation_dict = l10n.UnicodeDict(dict(([code, country_dict[code]['language']] for code in country_dict)))
		UserConfigSetupItem.__init__(self, *args, **kw)
		return None



class OSDLanguageUserConfigSetupItem(UserConfigSetupItem):

	depth = 2
	translation_dict = dict(([code, country_dict[code]['raw_language']] for code in country_dict))

	def __init__(self, exec_callback=False, **kw):
		UserConfigSetupItem.__init__(self, **kw)
		self.exec_callback = exec_callback
		return None

	def execute_action(self, val):
		l10n.set_language(val)
		if self.exec_callback and hasattr(self.menu, 'related_menu'):
			self.menu.related_menu.on_modify_lang()
		try:
			iso_639_lang = country_dict[val]['iso-639-2']
			from pygui.item.parameters.tv import wyscanserver
			wyscan = wyscanserver()
			wyscan.SetIso639LanguageCode(iso_639_lang)
		except Exception , e:
			log.warn('Unable to set the language for wyscan (%r)', e)
		return None



class FirstBootLanguageUserConfigSetupItem(OSDLanguageUserConfigSetupItem):

	def execute_action(self, val):
		config.user_config['video']['language'] = val
		OSDLanguageUserConfigSetupItem.execute_action(self, val)
		return None
