# -*- coding: utf-8 -*- 
#
# Description:
#
# Wymedia Module Entry Point
#
#
#
# Changes:
#
# 2011-11-10
# Initial Commit
# Hooking function for Wymedia "browse_ng".
# This allow to update Sqlite DB to make new files to appear in GUI.
# Add ".flac" file handling.
#
# 2012-05-01
# Add ".rtmp" file handling.
#
#
#
# Copyright 2010-2012, WyDev Team.
# Author: Polo35 (polo35580@hotmail.fr)
#
# Licenced under Academic Free License version 3.0
# Review WyGui README & LICENSE files for further details.


import os
import urllib
import sqlite3
from peewee.debug import GET_LOGGER
from wymedia.wmplus import browse_ng

log = GET_LOGGER(__name__)



# Hooking function for Wymedia "browse_ng".
# This allow to update Sqlite DB to make new files to appear in GUI.
def browse_ng_new(wymedia_resource, start, end, _sort, options):

	# Call original "browse_ng" function.
	# If we browse a new directory, this will insert entries in Sqlite DB.
	ret = browse_ng(wymedia_resource, start, end, _sort, options)

	# List files in browsed directory
	uri = wymedia_resource.get('uri', '')
	if uri.startswith('file:///'):
		path = urllib.unquote(uri[7:])
		for files in os.listdir(path):
			# If we find files with extention we want to see in GUI, try to update them in WyDB
			if files.endswith('.flac'):
				# Open connection to Wy Sqlite DB.
				sqlite_connection = sqlite3.connect("/etc/params/wymedia/.wyplay_db.-1.db")
				sqlite_cursor = sqlite_connection.cursor()	
				# Try to find entries with new extentions
				sqlite_cursor.execute("SELECT * FROM object WHERE path LIKE '%.flac' AND class='object.item'")
				# If sqlite_cursor contain something, this mean new files were found and we have to update Sqlite DB to make them appear in GUI.
				if sqlite_cursor.fetchone() is not None:
					log.debug('Found not updated .flac files. Updating...')
					sqlite_cursor.execute("UPDATE object SET universe='audio' WHERE path LIKE '%.flac' AND class='object.item'")
					sqlite_cursor.execute("UPDATE object SET mimeType='audio/x-flac' WHERE path LIKE '%.flac' AND class='object.item'")
					sqlite_cursor.execute("UPDATE object SET class='object.item.audioItem.flacItem' WHERE path LIKE '%.flac' AND class='object.item'")
					sqlite_connection.commit()
					log.debug('Done!')
					# Call original "browse_ng" function. This time new files will be added
					ret = browse_ng(wymedia_resource, start, end, _sort, options)
				else:
					log.debug('No not updated .flac files found.')
				# Close Sqlite connection
				sqlite_cursor.close()
			elif files.endswith('.rtmp'):
				# Open connection to Wy Sqlite DB.
				sqlite_connection = sqlite3.connect("/etc/params/wymedia/.wyplay_db.-1.db")
				sqlite_cursor = sqlite_connection.cursor()	
				# Try to find entries with new extentions
				sqlite_cursor.execute("SELECT * FROM object WHERE path LIKE '%.rtmp' AND class='object.item'")
				# If sqlite_cursor contain something, this mean new files were found and we have to update Sqlite DB to make them appear in GUI.
				if sqlite_cursor.fetchone() is not None:
					log.debug('Found not updated .rtmp files. Updating...')
					sqlite_cursor.execute("UPDATE object SET universe='video' WHERE path LIKE '%.rtmp' AND class='object.item'")
					sqlite_cursor.execute("UPDATE object SET mimeType='video/x-flv' WHERE path LIKE '%.rtmp' AND class='object.item'")
					sqlite_cursor.execute("UPDATE object SET class='object.item.videoItem.rtmpItem' WHERE path LIKE '%.rtmp' AND class='object.item'")
					sqlite_connection.commit()
					log.debug('Done!')
					# Call original "browse_ng" function. This time new files will be added
					ret = browse_ng(wymedia_resource, start, end, _sort, options)
				else:
					log.debug('No not updated .rtmp files found.')
				# Close Sqlite connection
				sqlite_cursor.close()

	# Return list of items
	return ret
